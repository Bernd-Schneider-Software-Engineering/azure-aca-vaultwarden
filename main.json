{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "14479989883472160647"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "appName": {
      "type": "string",
      "defaultValue": "vault",
      "metadata": {
        "description": "Name of the Vaultwarden Container App"
      }
    },
    "domainUrl": {
      "type": "string",
      "metadata": {
        "description": "Public URL of your Vaultwarden instance. MUST include https:// (example: https://sub.domain.tld)"
      }
    },
    "startPaused": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "If true, deploy the Container App with minReplicas=0 (paused, no instances running). NOTE: For Azure managed certificates / domain validation the app must be reachable, so set this to false during certificate provisioning."
      }
    },
    "vaultwardenImage": {
      "type": "string",
      "defaultValue": "vaultwarden/server:1.35.2-alpine",
      "metadata": {
        "description": "Container image to use for Vaultwarden (pin a version for reproducible deployments)"
      }
    },
    "cpuCores": {
      "type": "string",
      "defaultValue": "0.25",
      "metadata": {
        "description": "CPU cores for the container"
      }
    },
    "memorySize": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "Memory in GiB for the container (CPU:RAM ratio must be 1:2)"
      }
    },
    "allowInsecureHttp": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow insecure HTTP traffic (recommended: false for production)"
      }
    },
    "smtpHost": {
      "type": "string",
      "defaultValue": "smtp.office365.com",
      "metadata": {
        "description": "SMTP host (M365 default: smtp.office365.com)"
      }
    },
    "smtpPort": {
      "type": "string",
      "defaultValue": "587",
      "metadata": {
        "description": "SMTP port (M365 default: 587)"
      }
    },
    "smtpSecurity": {
      "type": "string",
      "defaultValue": "starttls",
      "allowedValues": [
        "starttls",
        "force_tls",
        "off"
      ],
      "metadata": {
        "description": "SMTP security (starttls / force_tls / off)"
      }
    },
    "smtpFrom": {
      "type": "string",
      "metadata": {
        "description": "SMTP FROM address (e.g. vaultwarden@domain.tld)"
      }
    },
    "smtpUsername": {
      "type": "string",
      "metadata": {
        "description": "SMTP username (often same as smtpFrom)"
      }
    },
    "smtpPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SMTP password"
      }
    },
    "dbAdminUser": {
      "type": "string",
      "defaultValue": "vaultwarden",
      "metadata": {
        "description": "PostgreSQL admin username"
      }
    },
    "dbPassword": {
      "type": "securestring",
      "metadata": {
        "description": "PostgreSQL admin password (auto-generated by default). NOT stored in Key Vault."
      },
      "defaultValue": "[concat(toUpper(newGuid()), newGuid())]"
    },
    "postgresSkuName": {
      "type": "string",
      "defaultValue": "Standard_B1ms",
      "metadata": {
        "description": "PostgreSQL SKU name"
      }
    },
    "postgresStorageGB": {
      "type": "int",
      "defaultValue": 32,
      "metadata": {
        "description": "PostgreSQL storage size in GB"
      }
    },
    "allowAzureServicesToPostgres": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Allow Azure services to access PostgreSQL (0.0.0.0 firewall rule). Recommended: true for Container Apps without VNet/NAT."
      }
    },
    "storageAccountSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Standard_GZRS",
        "Standard_RAGZRS"
      ],
      "metadata": {
        "description": "Storage account SKU for Azure Files"
      }
    },
    "invitationOrgName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Organization name shown in invitation emails (INVITATION_ORG_NAME)"
      }
    },
    "signupsDomainsWhitelist": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Comma-separated email domain whitelist for signups (SIGNUPS_DOMAINS_WHITELIST)"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "allowedValues": [
        "prod",
        "test",
        "dev"
      ],
      "metadata": {
        "description": "Kosten/Zuordnung: Umgebung (prod/test/dev)"
      }
    },
    "bsseRef": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Traceability: BSSE Deploy-Ref (z.B. Git Tag oder Commit SHA)"
      }
    }
  },
  "variables": {
    "storageAccountName": "[toLower(format('{0}files{1}', parameters('appName'), uniqueString(resourceGroup().id)))]",
    "fileShareName": "vaultwarden",
    "postgresServerName": "[toLower(format('{0}-pg-{1}', parameters('appName'), uniqueString(resourceGroup().id)))]",
    "postgresDbName": "vaultwarden",
    "postgresFqdn": "[format('{0}.postgres.database.azure.com', variables('postgresServerName'))]",
    "postgresPort": "5432",
    "logAnalyticsName": "[format('{0}-law', parameters('appName'))]",
    "containerEnvName": "[format('{0}-env', parameters('appName'))]",
    "keyVaultName": "[toLower(format('vwkv{0}{1}', uniqueString(resourceGroup().id), substring(uniqueString(deployment().name),0,4)))]",
    "kvSecretAdminTokenName": "vw-admin-token",
    "roleKeyVaultSecretsOfficer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
    "roleKeyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
    "kvSecretDatabaseUrlName": "vw-database-url",
    "kvSecretSmtpPasswordName": "vw-smtp-password",
    "templateLinkUri": "[if(contains(deployment().properties,'templateLink'), if(contains(deployment().properties.templateLink,'uri'), deployment().properties.templateLink.uri, ''), '')]",
    "templateLinkRefRaw": "[if(contains(variables('templateLinkUri'), 'raw.githubusercontent.com'), split(variables('templateLinkUri'), '/')[5], variables('templateLinkUri'))]",
    "bsseRefRaw": "[if(empty(parameters('bsseRef')), if(empty(variables('templateLinkRefRaw')), 'local', variables('templateLinkRefRaw')), parameters('bsseRef'))]",
    "bsseRefEffective": "[if(empty(variables('bsseRefRaw')), '', substring(variables('bsseRefRaw'), 0, min(length(variables('bsseRefRaw')), 256)))]",
    "commonTags": "[createObject('Environment', parameters('environment'), 'bsse:ref', variables('bsseRefEffective'))]",
    "kvSecretDbAppPasswordName": "vw-db-app-password",
    "dbAppUser": "vw_app"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2023-09-01",
      "name": "[variables('logAnalyticsName')]",
      "location": "[parameters('location')]",
      "properties": {
        "retentionInDays": 30
      },
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('storageAccountSku')]"
      },
      "kind": "StorageV2",
      "properties": {
        "allowBlobPublicAccess": false,
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true
      },
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', variables('fileShareName'))]",
      "properties": {
        "accessTier": "Hot"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('storageAccountName'), 'default')]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "enableRbacAuthorization": true,
        "enabledForDeployment": false,
        "enabledForTemplateDeployment": true,
        "enabledForDiskEncryption": false,
        "publicNetworkAccess": "Enabled",
        "softDeleteRetentionInDays": 90,
        "enablePurgeProtection": true
      },
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[format('{0}-id', parameters('appName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[format('{0}-kv-writer-id', parameters('appName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))), variables('roleKeyVaultSecretsOfficer'))]",
      "properties": {
        "roleDefinitionId": "[variables('roleKeyVaultSecretsOfficer')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))), variables('roleKeyVaultSecretsUser'))]",
      "properties": {
        "roleDefinitionId": "[variables('roleKeyVaultSecretsUser')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}-ensure-kv-secrets', parameters('appName'))]",
      "location": "[parameters('location')]",
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))))]": {}
        }
      },
      "properties": {
        "azCliVersion": "2.83.0",
        "timeout": "PT30M",
        "retentionInterval": "P1D",
        "cleanupPreference": "OnSuccess",
        "environmentVariables": [
          {
            "name": "KEYVAULT_NAME",
            "value": "[variables('keyVaultName')]"
          },
          {
            "name": "ADMIN_TOKEN_SECRET",
            "value": "[variables('kvSecretAdminTokenName')]"
          },
          {
            "name": "SMTP_PASSWORD_SECRET",
            "value": "[variables('kvSecretSmtpPasswordName')]"
          },
          {
            "name": "SMTP_PASSWORD_VALUE",
            "secureValue": "[parameters('smtpPassword')]"
          },
          {
            "name": "DATABASE_URL_SECRET",
            "value": "[variables('kvSecretDatabaseUrlName')]"
          },
          {
            "name": "POSTGRES_FQDN",
            "value": "[variables('postgresFqdn')]"
          },
          {
            "name": "POSTGRES_PORT",
            "value": "[string(variables('postgresPort'))]"
          },
          {
            "name": "POSTGRES_DBNAME",
            "value": "[variables('postgresDbName')]"
          },
          {
            "name": "DB_ADMIN_USER",
            "value": "[parameters('dbAdminUser')]"
          },
          {
            "name": "TLS_SSLMODE",
            "value": "require"
          },
          {
            "name": "POSTGRES_SERVER_NAME",
            "value": "[variables('postgresServerName')]"
          },
          {
            "name": "DB_ADMIN_PASSWORD",
            "secureValue": "[parameters('dbPassword')]"
          },
          {
            "name": "DB_APP_USER",
            "value": "[variables('dbAppUser')]"
          },
          {
            "name": "DB_APP_PASSWORD_SECRET",
            "value": "[variables('kvSecretDbAppPasswordName')]"
          },
          {
            "name": "UAMI_CLIENT_ID",
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))), '2018-11-30').clientId]"
          }
        ],
        "scriptContent": "set -euo pipefail\n\necho \"[vault-ensure-kv-secrets] ensuring Key Vault secrets exist in $KEYVAULT_NAME ...\"\n\n# Ensure we are authenticated (deploymentScripts should use the assigned managed identity, but harden against missing session)\nif ! az account show 1>/dev/null 2>/dev/null; then\n  echo \"[vault-ensure-kv-secrets] az account not available - logging in with managed identity\"\n  if [ -n \"${UAMI_CLIENT_ID:-}\" ]; then\n    az login --identity --client-id \"$UAMI_CLIENT_ID\" 1>/dev/null\n  else\n    az login --identity 1>/dev/null\n  fi\nfi\n\n# ------------------------------------------------------------\n# PostgreSQL tooling\n# ------------------------------------------------------------\n# Prefer psql, but deploymentScripts can run on different Linux base images where package managers vary.\n# If we cannot install psql, fall back to a pure-Python driver (pg8000).\n\nUSE_PYPG=0\n\nif ! command -v psql 1>/dev/null 2>/dev/null; then\n  echo \"[vault-ensure-kv-secrets] psql not found - attempting to install PostgreSQL client\"\n  echo \"[vault-ensure-kv-secrets] OS info:\"\n  (cat /etc/os-release || true) | sed 's/^/[vault-ensure-kv-secrets]   /'\n\n  echo \"[vault-ensure-kv-secrets] Detected package managers:\"\n  for c in apk tdnf apt-get yum dnf microdnf; do\n    if command -v \"$c\" 1>/dev/null 2>/dev/null; then\n      echo \"[vault-ensure-kv-secrets]   - $c\"\n    fi\n  done\n\n  if command -v apk 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] installing via apk ...\"\n    apk update\n    apk add --no-cache postgresql-client 2>/dev/null || apk add --no-cache postgresql\n  elif command -v tdnf 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] installing via tdnf ...\"\n    tdnf install -y postgresql 2>/dev/null || tdnf install -y postgresql-client\n  elif command -v apt-get 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] installing via apt-get ...\"\n    if [ \"$(id -u)\" -ne 0 ] && command -v sudo 1>/dev/null 2>/dev/null; then\n      SUDO=\"sudo\"\n    else\n      SUDO=\"\"\n    fi\n    $SUDO apt-get update -y\n    $SUDO apt-get install -y postgresql-client\n  elif command -v yum 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] installing via yum ...\"\n    yum install -y postgresql\n  elif command -v dnf 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] installing via dnf ...\"\n    dnf install -y postgresql\n  elif command -v microdnf 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] installing via microdnf ...\"\n    microdnf install -y postgresql\n  else\n    echo \"[vault-ensure-kv-secrets] No supported package manager found. Falling back to pure-Python pg8000.\"\n    USE_PYPG=1\n  fi\n\n  if [ \"$USE_PYPG\" -eq 0 ] && ! command -v psql 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] WARNING: psql install path did not yield psql. Falling back to pure-Python pg8000.\"\n    USE_PYPG=1\n  fi\nfi\n\n# If using python fallback, ensure pg8000 is available (pure python, no system libpq needed)\nif [ \"$USE_PYPG\" -eq 1 ]; then\n  echo \"[vault-ensure-kv-secrets] ensuring python driver pg8000 is available ...\"\n  python3 -m pip install --no-cache-dir -q pg8000\nfi\n\n# ------------------------------------------------------------\n# Wait for Key Vault RBAC/permissions to become effective\n# ------------------------------------------------------------\necho \"[vault-ensure-kv-secrets] waiting for Key Vault permissions...\"\nfor i in $(seq 1 30); do\n  if az keyvault secret list --vault-name \"$KEYVAULT_NAME\" --maxresults 1 1>/dev/null 2>/dev/null; then\n    echo \"[vault-ensure-kv-secrets] Key Vault access OK\"\n    break\n  fi\n  echo \"[vault-ensure-kv-secrets] Key Vault access not ready yet ($i/30), sleeping 10s...\"\n  sleep 10\n  if [ \"$i\" -eq 30 ]; then\n    echo \"[vault-ensure-kv-secrets] ERROR: Key Vault permissions not ready after 300s\"\n    exit 1\n  fi\ndone\n\n# ------------------------------------------------------------\n# Wait for PostgreSQL to accept connections\n# ------------------------------------------------------------\necho \"[vault-ensure-kv-secrets] waiting for PostgreSQL connectivity...\"\nexport PGPASSWORD=\"${DB_ADMIN_PASSWORD}\"\n\nif [ \"$USE_PYPG\" -eq 0 ]; then\n  PG_CONN_ADMIN=\"host=${POSTGRES_FQDN} port=${POSTGRES_PORT} dbname=postgres user=${DB_ADMIN_USER} sslmode=${TLS_SSLMODE}\"\n  for i in $(seq 1 30); do\n    if psql \"${PG_CONN_ADMIN}\" -v ON_ERROR_STOP=1 -c \"SELECT 1\" 1>/dev/null 2>/dev/null; then\n      echo \"[vault-ensure-kv-secrets] PostgreSQL reachable\"\n      break\n    fi\n    echo \"[vault-ensure-kv-secrets] PostgreSQL not ready yet ($i/30), sleeping 10s...\"\n    sleep 10\n    if [ \"$i\" -eq 30 ]; then\n      echo \"[vault-ensure-kv-secrets] ERROR: PostgreSQL not reachable after 300s\"\n      exit 1\n    fi\n  done\nelse\n  python3 - <<'PY'\nimport os, time, ssl\nimport pg8000\n\nhost=os.environ[\"POSTGRES_FQDN\"]\nport=int(os.environ.get(\"POSTGRES_PORT\",\"5432\"))\nuser=os.environ[\"DB_ADMIN_USER\"]\npw=os.environ[\"DB_ADMIN_PASSWORD\"]\ndb=\"postgres\"\n\n# Match \"sslmode=require\" semantics: encryption without hostname / chain validation\nctx=ssl.create_default_context()\nctx.check_hostname=False\nctx.verify_mode=ssl.CERT_NONE\n\nfor i in range(30):\n  try:\n    conn=pg8000.connect(host=host, port=port, user=user, password=pw, database=db, ssl_context=ctx, timeout=10)\n    conn.autocommit=True\n    cur=conn.cursor()\n    cur.execute(\"SELECT 1\")\n    cur.close()\n    conn.close()\n    print(\"[vault-ensure-kv-secrets] PostgreSQL reachable\")\n    break\n  except Exception as e:\n    print(f\"[vault-ensure-kv-secrets] PostgreSQL not ready yet ({i+1}/30): {e}\")\n    time.sleep(10)\nelse:\n  raise SystemExit(\"[vault-ensure-kv-secrets] ERROR: PostgreSQL not reachable after 300s\")\nPY\nfi\n\n# ------------------------------------------------------------\n# Secrets in Key Vault\n# ------------------------------------------------------------\n\n# --- ADMIN_TOKEN ---\nif az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$ADMIN_TOKEN_SECRET\" 1>/dev/null 2>/dev/null; then\n  echo \"ADMIN_TOKEN secret already exists.\"\nelse\n  echo \"Creating ADMIN_TOKEN secret...\"\n  ADMIN_TOKEN=$(python3 - << 'PY'\nimport secrets, base64\nprint(base64.urlsafe_b64encode(secrets.token_bytes(48)).decode('utf-8').rstrip('='))\nPY\n)\n  az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$ADMIN_TOKEN_SECRET\" --value \"$ADMIN_TOKEN\" 1>/dev/null\n  echo \"ADMIN_TOKEN secret created.\"\nfi\n\n# --- SMTP password ---\nif az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$SMTP_PASSWORD_SECRET\" 1>/dev/null 2>/dev/null; then\n  echo \"SMTP password secret already exists.\"\nelse\n  echo \"Creating SMTP password secret...\"\n  az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$SMTP_PASSWORD_SECRET\" --value \"$SMTP_PASSWORD_VALUE\" 1>/dev/null\n  echo \"SMTP password secret created.\"\nfi\n\n# --- App DB password (least-privilege user for Vaultwarden) ---\nif az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$DB_APP_PASSWORD_SECRET\" 1>/dev/null 2>/dev/null; then\n  echo \"App DB password secret already exists.\"\n  DB_APP_PASSWORD=$(az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$DB_APP_PASSWORD_SECRET\" --query value -o tsv)\nelse\n  echo \"Creating App DB password secret...\"\n  DB_APP_PASSWORD=$(python3 - << 'PY'\nimport secrets\nprint(secrets.token_urlsafe(32))  # safe chars for SQL + URL encoding later\nPY\n)\n  az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$DB_APP_PASSWORD_SECRET\" --value \"$DB_APP_PASSWORD\" 1>/dev/null\n  echo \"App DB password secret created.\"\nfi\n\nexport DB_APP_PASSWORD=\"$DB_APP_PASSWORD\"\n\n# ------------------------------------------------------------\n# Provision least-privilege role & grants (idempotent)\n# ------------------------------------------------------------\necho \"Provisioning Postgres role '$DB_APP_USER' and database privileges (idempotent) ...\"\n\nif [ \"$USE_PYPG\" -eq 0 ]; then\n  PG_CONN_ADMIN=\"host=${POSTGRES_FQDN} port=${POSTGRES_PORT} dbname=postgres user=${DB_ADMIN_USER} sslmode=${TLS_SSLMODE}\"\n  psql \"${PG_CONN_ADMIN}\" -v ON_ERROR_STOP=1 <<SQL 1>/dev/null\nDO \\$\\$\nBEGIN\n  IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '${DB_APP_USER}') THEN\n    CREATE ROLE \"${DB_APP_USER}\" LOGIN PASSWORD '${DB_APP_PASSWORD}';\n  END IF;\nEND\n\\$\\$;\n\nALTER ROLE \"${DB_APP_USER}\"\n  WITH LOGIN PASSWORD '${DB_APP_PASSWORD}'\n  NOCREATEDB NOCREATEROLE NOINHERIT;\n\nGRANT CONNECT ON DATABASE \"${POSTGRES_DBNAME}\" TO \"${DB_APP_USER}\";\nSQL\n\n  PG_CONN_VWDB=\"host=${POSTGRES_FQDN} port=${POSTGRES_PORT} dbname=${POSTGRES_DBNAME} user=${DB_ADMIN_USER} sslmode=${TLS_SSLMODE}\"\n  psql \"${PG_CONN_VWDB}\" -v ON_ERROR_STOP=1 <<SQL 1>/dev/null\nGRANT USAGE, CREATE ON SCHEMA public TO \"${DB_APP_USER}\";\nSQL\nelse\n  python3 - <<'PY'\nimport os, ssl\nimport pg8000\n\nhost=os.environ[\"POSTGRES_FQDN\"]\nport=int(os.environ.get(\"POSTGRES_PORT\",\"5432\"))\nadmin_user=os.environ[\"DB_ADMIN_USER\"]\nadmin_pw=os.environ[\"DB_ADMIN_PASSWORD\"]\ndb_name=os.environ[\"POSTGRES_DBNAME\"]\napp_user=os.environ[\"DB_APP_USER\"]\napp_pw=os.environ[\"DB_APP_PASSWORD\"]\n\nctx=ssl.create_default_context()\nctx.check_hostname=False\nctx.verify_mode=ssl.CERT_NONE\n\ndef run(database, sql):\n  conn=pg8000.connect(host=host, port=port, user=admin_user, password=admin_pw, database=database, ssl_context=ctx, timeout=20)\n  conn.autocommit=True\n  cur=conn.cursor()\n  cur.execute(sql)\n  cur.close()\n  conn.close()\n\nsql_admin = (\n  \"DO $$\\n\"\n  \"BEGIN\\n\"\n  f\"  IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '{app_user}') THEN\\n\"\n  f\"    CREATE ROLE \\\"{app_user}\\\" LOGIN PASSWORD '{app_pw}';\\n\"\n  \"  END IF;\\n\"\n  \"END\\n\"\n  \"$$;\\n\\n\"\n  f\"ALTER ROLE \\\"{app_user}\\\" WITH LOGIN PASSWORD '{app_pw}' NOCREATEDB NOCREATEROLE NOINHERIT;\\n\"\n  f\"GRANT CONNECT ON DATABASE \\\"{db_name}\\\" TO \\\"{app_user}\\\";\\n\"\n)\n\nrun(\"postgres\", sql_admin)\nrun(db_name, f\"GRANT USAGE, CREATE ON SCHEMA public TO \\\"{app_user}\\\";\")\n\nprint(\"Postgres provisioning done.\")\nPY\nfi\n\n# ------------------------------------------------------------\n# DATABASE_URL (PostgreSQL connection string for Vaultwarden)\n# ------------------------------------------------------------\nENCODED_APP_PASSWORD=$(python3 - << 'PY'\nimport os, urllib.parse\nprint(urllib.parse.quote(os.environ.get(\"DB_APP_PASSWORD\",\"\"), safe=\"\"))\nPY\n)\n\nDATABASE_URL=\"postgresql://${DB_APP_USER}:${ENCODED_APP_PASSWORD}@${POSTGRES_FQDN}:${POSTGRES_PORT}/${POSTGRES_DBNAME}?sslmode=${TLS_SSLMODE}\"\n\nif az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$DATABASE_URL_SECRET\" 1>/dev/null 2>/dev/null; then\n  CURRENT_DBURL=$(az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$DATABASE_URL_SECRET\" --query value -o tsv || echo \"\")\n  if echo \"$CURRENT_DBURL\" | grep -qiE '^postgres(ql)?://'; then\n    if echo \"$CURRENT_DBURL\" | grep -q \"://${DB_ADMIN_USER}:\"; then\n      echo \"DATABASE_URL currently uses admin user; updating to app user...\"\n      az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$DATABASE_URL_SECRET\" --value \"$DATABASE_URL\" 1>/dev/null\n      echo \"DATABASE_URL secret updated.\"\n    else\n      echo \"DATABASE_URL secret already exists and looks valid.\"\n    fi\n  else\n    echo \"DATABASE_URL secret exists but looks invalid; updating to PostgreSQL URL...\"\n    az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$DATABASE_URL_SECRET\" --value \"$DATABASE_URL\" 1>/dev/null\n    echo \"DATABASE_URL secret updated.\"\n  fi\nelse\n  echo \"Creating DATABASE_URL secret...\"\n  az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$DATABASE_URL_SECRET\" --value \"$DATABASE_URL\" 1>/dev/null\n  echo \"DATABASE_URL secret created.\"\nfi\n\n# Non-sensitive output (for troubleshooting/visibility)\ncat > \"$AZ_SCRIPTS_OUTPUT_PATH\" <<JSON\n{\n  \"status\": \"ok\"\n}\nJSON\n\necho \"Done.\"\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))), variables('roleKeyVaultSecretsOfficer')))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', variables('postgresServerName'), variables('postgresDbName'))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2023-03-01-preview",
      "name": "[variables('postgresServerName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('postgresSkuName')]",
        "tier": "Burstable"
      },
      "properties": {
        "administratorLogin": "[parameters('dbAdminUser')]",
        "administratorLoginPassword": "[parameters('dbPassword')]",
        "version": "15",
        "storage": {
          "storageSizeGB": "[parameters('postgresStorageGB')]"
        },
        "authConfig": {
          "passwordAuth": "Enabled",
          "activeDirectoryAuth": "Disabled"
        },
        "backup": {
          "backupRetentionDays": 7
        }
      },
      "tags": "[variables('commonTags')]"
    },
    {
      "condition": "[parameters('allowAzureServicesToPostgres')]",
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
      "apiVersion": "2023-03-01-preview",
      "name": "[format('{0}/{1}', variables('postgresServerName'), 'AllowAzure')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2023-03-01-preview",
      "name": "[format('{0}/{1}', variables('postgresServerName'), variables('postgresDbName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ]
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-03-01",
      "name": "[variables('containerEnvName')]",
      "location": "[parameters('location')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2023-09-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2023-09-01').primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      ],
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.App/managedEnvironments/storages",
      "apiVersion": "2024-03-01",
      "name": "[format('{0}/{1}', variables('containerEnvName'), 'vaultwarden-storage')]",
      "properties": {
        "azureFile": {
          "accountName": "[variables('storageAccountName')]",
          "shareName": "[variables('fileShareName')]",
          "accountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-05-01').keys[0].value]",
          "accessMode": "ReadWrite"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerEnvName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/fileServices/shares', variables('storageAccountName'), 'default', variables('fileShareName'))]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[parameters('appName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))))]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerEnvName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": 80,
            "allowInsecure": "[parameters('allowInsecureHttp')]"
          },
          "secrets": [
            {
              "name": "admin-token",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]",
              "keyVaultUrl": "[format('https://{0}.vault.azure.net/secrets/{1}', variables('keyVaultName'), variables('kvSecretAdminTokenName'))]"
            },
            {
              "name": "smtp-password",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]",
              "keyVaultUrl": "[format('https://{0}.vault.azure.net/secrets/{1}', variables('keyVaultName'), variables('kvSecretSmtpPasswordName'))]"
            },
            {
              "name": "database-url",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]",
              "keyVaultUrl": "[format('https://{0}.vault.azure.net/secrets/{1}', variables('keyVaultName'), variables('kvSecretDatabaseUrlName'))]"
            }
          ],
          "activeRevisionsMode": "Single"
        },
        "template": {
          "containers": [
            {
              "name": "vaultwarden",
              "image": "[parameters('vaultwardenImage')]",
              "resources": {
                "cpu": "[json(parameters('cpuCores'))]",
                "memory": "[format('{0}Gi', parameters('memorySize'))]"
              },
              "env": [
                {
                  "name": "ADMIN_TOKEN",
                  "secretRef": "admin-token"
                },
                {
                  "name": "DATABASE_URL",
                  "secretRef": "database-url"
                },
                {
                  "name": "DOMAIN",
                  "value": "[parameters('domainUrl')]"
                },
                {
                  "name": "EMAIL_2FA_AUTO_FALLBACK",
                  "value": "false"
                },
                {
                  "name": "HTTP_REQUEST_BLOCK_NON_GLOBAL_IPS",
                  "value": "true"
                },
                {
                  "name": "INVITATIONS_ALLOWED",
                  "value": "true"
                },
                {
                  "name": "INVITATION_ORG_NAME",
                  "value": "[parameters('invitationOrgName')]"
                },
                {
                  "name": "SHOW_PASSWORD_HINT",
                  "value": "false"
                },
                {
                  "name": "SIGNUPS_ALLOWED",
                  "value": "false"
                },
                {
                  "name": "SIGNUPS_DOMAINS_WHITELIST",
                  "value": "[parameters('signupsDomainsWhitelist')]"
                },
                {
                  "name": "SMTP_FROM",
                  "value": "[parameters('smtpFrom')]"
                },
                {
                  "name": "SMTP_HOST",
                  "value": "[parameters('smtpHost')]"
                },
                {
                  "name": "SMTP_PASSWORD",
                  "secretRef": "smtp-password"
                },
                {
                  "name": "SMTP_PORT",
                  "value": "[parameters('smtpPort')]"
                },
                {
                  "name": "SMTP_SECURITY",
                  "value": "[parameters('smtpSecurity')]"
                },
                {
                  "name": "SMTP_USERNAME",
                  "value": "[parameters('smtpUsername')]"
                }
              ],
              "volumeMounts": [
                {
                  "volumeName": "data",
                  "mountPath": "/data"
                }
              ]
            }
          ],
          "volumes": [
            {
              "name": "data",
              "storageType": "AzureFile",
              "storageName": "vaultwarden-storage"
            }
          ],
          "scale": {
            "minReplicas": "[if(parameters('startPaused'), 0, 1)]",
            "maxReplicas": 1
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]",
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerEnvName'))]",
        "[resourceId('Microsoft.App/managedEnvironments/storages', variables('containerEnvName'), 'vaultwarden-storage')]",
        "[resourceId('Microsoft.Resources/deploymentScripts', format('{0}-ensure-kv-secrets', parameters('appName')))]",
        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))), variables('roleKeyVaultSecretsUser')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', variables('postgresServerName'), variables('postgresDbName'))]"
      ],
      "tags": "[variables('commonTags')]"
    }
  ],
  "outputs": {
    "containerAppFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('appName')), '2024-03-01').configuration.ingress.fqdn]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[variables('keyVaultName')]"
    }
  }
}